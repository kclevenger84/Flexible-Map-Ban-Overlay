<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valorant Map Overlay</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="overlay-grid" id="map-grid"></div>

  <script>
    // Map pools for both games
    const valorantMaps = ["Ascent", "Bind", "Corrode", "Haven", "Icebox", "Lotus", "Sunset"];
    const ow2Maps = {
      control: ["Antarctic Peninsula", "Busan", "Ilios", "Lijiang Tower", "Nepal", "Oasis", "Samoa"],
      escort: ["Circuit Royal", "Dorado", "Havana", "Junkertown", "Rialto", "Route 66", "Shambali Monastery", "Gibraltar"],
      hybrid: ["Blizzard World", "Eichenwalde", "Hollywood", "King's Row", "Midtown", "Numbani", "Paraiso"],
      push: ["Colosseo", "Esperanca", "New Queen Street", "Runasapi"],
      flashpoint: ["Aatlis", "Suravasa", "New Junk City"]
    };

    let currentGame = "valorant";
    let currentCategory = "control";

    const mapGrid = document.getElementById("map-grid");

    function renderMapGrid(game, category) {
      mapGrid.innerHTML = "";
      let mapsToShow = [];
      if (game === "valorant") {
        mapsToShow = valorantMaps;
      } else if (game === "overwatch2") {
        mapsToShow = ow2Maps[category] || [];
      }
      mapsToShow.forEach((map) => {
        const card = document.createElement("div");
        card.className = "map-card";
        card.id = `map-${map}`;
        card.dataset.color = "";

        // URL-encode the map name for the image src
        const encodedMapName = encodeURIComponent(map);

        card.innerHTML = `
        <div class="label">${map}</div>
        <img src="images/${encodedMapName}.jpg" alt="${map}">
        <div class="ban-label" id="${map}-ban"></div>
        <div class="pick-label" id="${map}-pick"></div>
        <div class="side-label" id="${map}-side"></div>
      `;

        mapGrid.appendChild(card);
      });
    }

    // Initial render
    renderMapGrid(currentGame, currentCategory);

    const socket = new WebSocket("ws://localhost:3000");

    socket.addEventListener("open", () => {
      console.log("Overlay WebSocket connection established");
    });

    socket.addEventListener("error", (error) => {
      console.error("Overlay WebSocket error:", error);
    });

    socket.addEventListener("close", () => {
      console.log("Overlay WebSocket connection closed");
    });

    socket.addEventListener("message", async (event) => {
      let rawData = event.data;
      if (rawData instanceof Blob) {
        rawData = await rawData.text();
      }

      const data = JSON.parse(rawData);
      console.log("Received data:", data);

      // Handle game/category switch
      if (data.action === "switch") {
        currentGame = data.game || "valorant";
        currentCategory = data.category || "control";
        renderMapGrid(currentGame, currentCategory);
        return;
      }

      // Handle reset
      if (data.action === "reset") {
        currentGame = data.game || "valorant";
        currentCategory = data.category || "control";
        renderMapGrid(currentGame, currentCategory);
        return;
      }

      const mapCard = document.getElementById(`map-${data.map}`);
      if (!mapCard) {
        console.error(`Map card not found for: ${data.map}`);
        return;
      }

      if (data.action === "ban") {
        mapCard.classList.add("banned");
        document.getElementById(`${data.map}-ban`).textContent = `${data.team} BANNED`;
      }

      if (data.action === "pick") {
        document.getElementById(`${data.map}-pick`).textContent = `${data.team} PICKED`;
      }

      if (data.action === "side") {
        document.getElementById(`${data.map}-side`).textContent = `${data.team} â†’ ${data.side.toUpperCase()}`;
      }

      if (data.color) {
        mapCard.style.setProperty("--team-color", data.color);
      }
    });
  </script>
</body>

</html>