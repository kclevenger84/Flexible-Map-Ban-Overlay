<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Map Pick/Ban Overlay 2</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: transparent;
    }

    .overlay-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .map-card {
      position: relative;
      width: 150px;
      height: 900px;
      overflow: hidden;
      border: 2px solid #555;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .map-card img {
      width: 150px;
      height: 900px;
      object-fit: cover;
      display: block;
    }

    .map-card .label {
      position: absolute;
      top: 8px;
      left: 0;
      width: 100%;
      text-align: center;
      font-weight: bold;
      font-size: 0.9em;
      color: #fff;
      text-shadow: 1px 1px 3px #000;
      z-index: 2;
    }

    .map-card .ban-label,
    .map-card .pick-label,
    .map-card .side-label {
      position: absolute;
      left: 0;
      width: 100%;
      text-align: center;
      font-weight: bold;
      font-size: 0.85em;
      color: #fff;
      text-shadow: 1px 1px 3px #000;
      z-index: 2;
    }

    .map-card .ban-label  { bottom: 60px; }
    .map-card .pick-label { bottom: 38px; }
    .map-card .side-label { bottom: 16px; }

    .map-card.banned::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(180, 0, 0, 0.55);
      z-index: 1;
    }

    .map-card.banned .ban-label,
    .map-card.banned .label {
      z-index: 3;
    }

    .map-card.picked::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 160, 0, 0.45);
      z-index: 1;
    }

    .map-card.picked .pick-label,
    .map-card.picked .label {
      z-index: 3;
    }

    /* Layout: hero ban left | maps | hero ban right */
    .main-layout {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .hero-ban-card {
      width: 150px;
      min-height: 220px;
      border: 2px dashed #888;
      border-radius: 10px;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: rgba(0, 0, 0, 0.5);
      box-sizing: border-box;
      padding: 10px;
      flex-shrink: 0;
    }

    .hero-ban-card img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      display: block;
      margin: 0 auto 8px;
      border-radius: 6px;
    }

    .hero-ban-name {
      font-weight: bold;
      font-size: 1em;
      color: #fff;
      text-align: center;
      min-height: 1.2em;
    }

    .hero-ban-team {
      font-size: 0.85em;
      color: #ff4444;
      text-align: center;
      min-height: 1.1em;
    }
  </style>
</head>

<body>
  <div style="text-align: center; font-size: 1.3em; font-weight: bold; margin-bottom: 8px;">Map Bans</div>

  <div class="main-layout">
    <!-- Team A hero ban on the left -->
    <div id="teamA-hero-ban" class="hero-ban-card" style="display: none;"></div>

    <!-- Map grid in the center -->
    <div class="overlay-grid" id="map-grid"></div>

    <!-- Team B hero ban on the right -->
    <div id="teamB-hero-ban" class="hero-ban-card" style="display: none;"></div>
  </div>

  <script>
    const valorantMaps = ["Ascent", "Bind", "Haven", "Icebox", "Lotus", "Split", "Sunset"];
    const ow2Maps = {
      control: ["Antarctic Peninsula", "Busan", "Ilios", "Lijiang Tower", "Nepal", "Oasis", "Samoa"],
      escort: ["Circuit Royal", "Dorado", "Havana", "Junkertown", "Rialto", "Route 66", "Shambali Monastery", "Gibraltar"],
      hybrid: ["Blizzard World", "Eichenwalde", "Hollywood", "King's Row", "Midtown", "Numbani", "Paraiso"],
      push: ["Colosseo", "Esperanca", "New Queen Street", "Runasapi"],
      flashpoint: ["Aatlis", "Suravasa", "New Junk City"]
    };

    const cs2Maps = ["Ancient", "Anubis", "Dust II", "Inferno", "Mirage", "Nuke", "Overpass"];

    let currentGame = "valorant";
    let currentCategory = "control";

    const mapGrid = document.getElementById("map-grid");

    function renderMapGrid(game, category) {
      mapGrid.innerHTML = "";
      let mapsToShow = [];
      if (game === "valorant") {
        mapsToShow = valorantMaps;
      } else if (game === "counterstrike2") {
        mapsToShow = cs2Maps;
      } else if (game === "overwatch2") {
        mapsToShow = ow2Maps[category] || [];
      }

      mapsToShow.forEach((map) => {
        const card = document.createElement("div");
        card.className = "map-card";
        card.id = `map-${map}`;
        card.dataset.color = "";

        const encodedMapName = encodeURIComponent(map);

        card.innerHTML = `
          <div class="label">${map}</div>
          <img src="images/maps/${encodedMapName}.jpg" alt="${map}">
          <div class="ban-label" id="${map}-ban"></div>
          <div class="pick-label" id="${map}-pick"></div>
          <div class="side-label" id="${map}-side"></div>
        `;

        mapGrid.appendChild(card);
      });
    }

    renderMapGrid(currentGame, currentCategory);

    function updateHeroBanVisibility() {
      const teamA = document.getElementById("teamA-hero-ban");
      const teamB = document.getElementById("teamB-hero-ban");
      if (currentGame === "overwatch2") {
        teamA.style.display = "flex";
        teamB.style.display = "flex";
      } else {
        teamA.style.display = "none";
        teamB.style.display = "none";
      }
    }
    updateHeroBanVisibility();

    const socket = new WebSocket("ws://localhost:3000");

    socket.addEventListener("open", () => console.log("Overlay WebSocket connection established"));
    socket.addEventListener("error", (error) => console.error("Overlay WebSocket error:", error));
    socket.addEventListener("close", () => console.log("Overlay WebSocket connection closed"));

    function setHeroBan(team, hero, teamName) {
      const banDiv = document.getElementById(`${team}-hero-ban`);
      if (hero) {
        banDiv.innerHTML = `
          <img src="images/heroes/${encodeURIComponent(hero)}.png" alt="${hero}">
          <div class="hero-ban-name">${hero}</div>
          <div class="hero-ban-team">${teamName ? teamName + " BANNED" : ""}</div>
        `;
        banDiv.style.borderStyle = "solid";
      } else {
        banDiv.innerHTML = `<div class="hero-ban-name"></div><div class="hero-ban-team"></div>`;
        banDiv.style.borderStyle = "dashed";
      }
    }

    setHeroBan("teamA", null);
    setHeroBan("teamB", null);

    socket.addEventListener("message", async (event) => {
      let rawData = event.data;
      if (rawData instanceof Blob) {
        rawData = await rawData.text();
      }

      const data = JSON.parse(rawData);
      console.log("Received data:", data);

      if (data.action === "heroBan") {
        setHeroBan(data.team, data.hero, data.teamName || data.team);
        return;
      }

      if (data.action === "side") {
        const mapCard = document.getElementById(`map-${data.map}`);
        if (mapCard) {
          const sideLabel = document.getElementById(`${data.map}-side`);
          if (sideLabel) {
            sideLabel.textContent = `${data.team} â†’ ${data.side.toUpperCase()}`;
          }
        }
        return;
      }

      if (data.action === "switch" || data.action === "reset") {
        currentGame = data.game || "valorant";
        currentCategory = data.category || "control";
        renderMapGrid(currentGame, currentCategory);
        setHeroBan("teamA", null);
        setHeroBan("teamB", null);
        updateHeroBanVisibility();
        return;
      }

      if (data.action === "ban") {
        const mapCard = document.getElementById(`map-${data.map}`);
        if (mapCard) {
          mapCard.classList.add("banned");
          mapCard.style.setProperty('--team-color', data.color || '#c00');
          const banLabel = document.getElementById(`${data.map}-ban`);
          if (banLabel) banLabel.textContent = `${data.team} BANNED`;
        }
        return;
      }

      if (data.action === "pick") {
        const mapCard = document.getElementById(`map-${data.map}`);
        if (mapCard) {
          mapCard.classList.add("picked");
          mapCard.style.setProperty('--team-color', data.color || '#000');
          const pickLabel = document.getElementById(`${data.map}-pick`);
          if (pickLabel) pickLabel.textContent = `${data.team} PICKED`;
        }
        return;
      }
    });
  </script>
</body>

</html>
